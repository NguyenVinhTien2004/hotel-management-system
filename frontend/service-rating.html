<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê√°nh gi√° d·ªãch v·ª• - Kh√°ch s·∫°n Cocotier</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .star-rating {
            display: flex;
            gap: 4px;
        }
        .star {
            font-size: 2rem;
            color: #d1d5db;
            cursor: pointer;
            transition: color 0.2s;
        }
        .star.active {
            color: #fbbf24;
        }
        .star:hover {
            color: #fbbf24;
        }
        .service-card {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            background: white;
        }
        .service-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 12px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="dashboard.html" class="w-8 h-8 bg-green-600 rounded-full flex items-center justify-center text-white font-bold mr-3">CD</a>
                    <h1 class="text-xl font-semibold">D·ªãch v·ª• kh√°ch s·∫°n</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-600" id="userInfo"></span>
                    <button onclick="logout()" class="text-red-600 hover:text-red-700">ƒêƒÉng xu·∫•t</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-4xl mx-auto py-6 px-4">
        <!-- Header v·ªõi th√¥ng tin ƒë·∫∑t ph√≤ng -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-2">ƒê√°nh gi√° d·ªãch v·ª•</h2>
            <div class="text-sm text-gray-600" id="bookingInfo">
                <p>Ph√≤ng 201 ‚Ä¢ 14/11/2025 - 16/11/2025</p>
            </div>
        </div>

        <!-- Form ƒë√°nh gi√° -->
        <form id="serviceRatingForm" class="space-y-6">
            <!-- ƒê√°nh gi√° ch·∫•t l∆∞·ª£ng ph√≤ng -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Ch·∫•t l∆∞·ª£ng ph√≤ng</h3>
                <div class="star-rating" data-rating="room">
                    <span class="star" data-value="1">‚òÖ</span>
                    <span class="star" data-value="2">‚òÖ</span>
                    <span class="star" data-value="3">‚òÖ</span>
                    <span class="star" data-value="4">‚òÖ</span>
                    <span class="star" data-value="5">‚òÖ</span>
                </div>
                <p class="text-sm text-gray-500 mt-2">Ch∆∞a ƒë√°nh gi√°</p>
            </div>

            <!-- ƒê√°nh gi√° ch·∫•t l∆∞·ª£ng ph·ª•c v·ª• nh√¢n vi√™n -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Ch·∫•t l∆∞·ª£ng ph·ª•c v·ª• nh√¢n vi√™n</h3>
                <div class="star-rating" data-rating="service">
                    <span class="star" data-value="1">‚òÖ</span>
                    <span class="star" data-value="2">‚òÖ</span>
                    <span class="star" data-value="3">‚òÖ</span>
                    <span class="star" data-value="4">‚òÖ</span>
                    <span class="star" data-value="5">‚òÖ</span>
                </div>
                <p class="text-sm text-gray-500 mt-2">Ch∆∞a ƒë√°nh gi√°</p>
            </div>

            <!-- ƒê√°nh gi√° ch·∫•t l∆∞·ª£ng d·ªãch v·ª• kh√°ch s·∫°n -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Ch·∫•t l∆∞·ª£ng d·ªãch v·ª• kh√°ch s·∫°n</h3>
                <div class="star-rating" data-rating="hotel-service">
                    <span class="star" data-value="1">‚òÖ</span>
                    <span class="star" data-value="2">‚òÖ</span>
                    <span class="star" data-value="3">‚òÖ</span>
                    <span class="star" data-value="4">‚òÖ</span>
                    <span class="star" data-value="5">‚òÖ</span>
                </div>
                <p class="text-sm text-gray-500 mt-2">Ch∆∞a ƒë√°nh gi√°</p>
            </div>

            <!-- ƒê√°nh gi√° ch·∫•t l∆∞·ª£ng d·ªãch v·ª• (ch·ªâ hi·ªÉn th·ªã n·∫øu c√≥ ƒë·∫∑t d·ªãch v·ª•) -->
            <div id="serviceQualitySection" class="bg-white rounded-lg shadow-sm p-6" style="display: none;">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Ch·∫•t l∆∞·ª£ng d·ªãch v·ª•</h3>
                <div id="bookedServicesRating">
                    <!-- Danh s√°ch d·ªãch v·ª• ƒë√£ ƒë·∫∑t s·∫Ω ƒë∆∞·ª£c load ·ªü ƒë√¢y -->
                </div>
            </div>

            <!-- Nh·∫≠n x√©t c·ªßa b·∫°n -->
            <div class="bg-white rounded-lg shadow-sm p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Nh·∫≠n x√©t c·ªßa b·∫°n</h3>
                <textarea 
                    id="comment" 
                    rows="4" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent"
                    placeholder="Chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n...">
                </textarea>
            </div>

            <!-- Buttons -->
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="goBack()" class="px-6 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50">
                    H·ªßy
                </button>
                <button type="submit" class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                    G·ª≠i ƒë√°nh gi√°
                </button>
            </div>
        </form>
    </div>

    <script>
        const API_URL = AppConfig.getApiUrl();
        let currentRoomRating = 0;
        let currentServiceRating = 0;
        let currentHotelServiceRating = 0;
        let currentBooking = null;
        let bookedServices = [];
        let serviceRatings = {};

        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'index.html';
                return;
            }
            
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            document.getElementById('userInfo').textContent = user.name || user.username;
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'index.html';
        }

        function goBack() {
            window.history.back();
        }

        // Star rating functionality
        document.querySelectorAll('.star-rating').forEach(rating => {
            const stars = rating.querySelectorAll('.star');
            const ratingType = rating.getAttribute('data-rating');
            
            stars.forEach((star, index) => {
                star.addEventListener('click', () => {
                    const value = index + 1;
                    if (ratingType === 'room') {
                        currentRoomRating = value;
                    } else if (ratingType === 'service') {
                        currentServiceRating = value;
                    } else if (ratingType === 'hotel-service') {
                        currentHotelServiceRating = value;
                    }
                    
                    updateStars(rating, value);
                    updateRatingText(rating, value);
                });
                
                star.addEventListener('mouseover', () => {
                    updateStars(rating, index + 1);
                });
            });
            
            rating.addEventListener('mouseleave', () => {
                let currentValue = 0;
                if (ratingType === 'room') {
                    currentValue = currentRoomRating;
                } else if (ratingType === 'service') {
                    currentValue = currentServiceRating;
                } else if (ratingType === 'hotel-service') {
                    currentValue = currentHotelServiceRating;
                }
                updateStars(rating, currentValue);
            });
        });

        function updateStars(ratingElement, value) {
            const stars = ratingElement.querySelectorAll('.star');
            stars.forEach((star, index) => {
                if (index < value) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        function updateRatingText(ratingElement, value) {
            const textElement = ratingElement.nextElementSibling;
            const ratingTexts = {
                1: 'R·∫•t t·ªá',
                2: 'T·ªá', 
                3: 'B√¨nh th∆∞·ªùng',
                4: 'T·ªët',
                5: 'Xu·∫•t s·∫Øc'
            };
            textElement.textContent = ratingTexts[value] || 'Ch∆∞a ƒë√°nh gi√°';
        }



        // Form submission
        document.getElementById('serviceRatingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (currentRoomRating === 0 || currentServiceRating === 0) {
                showMessage('Vui l√≤ng ƒë√°nh gi√° ch·∫•t l∆∞·ª£ng ph√≤ng v√† ph·ª•c v·ª• nh√¢n vi√™n', 'error');
                return;
            }
            
            // Hi·ªÉn th·ªã loading
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'ƒêang g·ª≠i...';
            
            try {
            
            // Ki·ªÉm tra ƒë√°nh gi√° d·ªãch v·ª• n·∫øu c√≥ d·ªãch v·ª• ƒë√£ ƒë·∫∑t
            if (bookedServices.length > 0) {
                const unratedServices = bookedServices.filter(service => !serviceRatings[service.service_id]);
                if (unratedServices.length > 0) {
                    alert('Vui l√≤ng ƒë√°nh gi√° t·∫•t c·∫£ c√°c d·ªãch v·ª• b·∫°n ƒë√£ s·ª≠ d·ª•ng');
                    return;
                }
            }
            
            const comment = document.getElementById('comment').value;
            
            try {
                // Get booking ID from URL params or use a default one for demo
                const urlParams = new URLSearchParams(window.location.search);
                const bookingId = urlParams.get('booking_id') || 1;
                
                console.log('Sending feedback:', {
                    booking_id: bookingId,
                    room_rating: currentRoomRating,
                    service_rating: currentServiceRating,
                    comment: comment
                });
                
                // G·ª≠i ƒë√°nh gi√° ch√≠nh
                const response = await fetch(`${API_URL}/feedback`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        booking_id: bookingId,
                        room_rating: currentRoomRating,
                        service_rating: currentServiceRating,
                        comment: comment
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    showMessage(error.message || 'C√≥ l·ªói x·∫£y ra khi g·ª≠i ƒë√°nh gi√°', 'error');
                    return;
                }
                
                // G·ª≠i ƒë√°nh gi√° d·ªãch v·ª• n·∫øu c√≥
                if (bookedServices.length > 0) {
                    for (const service of bookedServices) {
                        const serviceId = service.service_id;
                        const rating = serviceRatings[serviceId];
                        const serviceComment = document.getElementById(`service-comment-${serviceId}`).value;
                        
                        await fetch(`${API_URL}/service-ratings`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('token')}`
                            },
                            body: JSON.stringify({
                                service_id: serviceId,
                                service_name: service.service_name,
                                booking_id: bookingId,
                                rating: rating,
                                comment: serviceComment
                            })
                        });
                    }
                }
                
                // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng
                showMessage('C·∫£m ∆°n b·∫°n ƒë√£ ƒë√°nh gi√°! Ph·∫£n h·ªìi c·ªßa b·∫°n r·∫•t quan tr·ªçng.', 'success');
                
                // Chuy·ªÉn h∆∞·ªõng sau 2 gi√¢y
                setTimeout(() => {
                    window.location.href = 'booking-history.html';
                }, 2000);
                
            } catch (error) {
                console.error('Error submitting rating:', error);
                showMessage('L·ªói k·∫øt n·ªëi server. Vui l√≤ng th·ª≠ l·∫°i.', 'error');
            } finally {
                // Kh√¥i ph·ª•c n√∫t submit
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        });
        
        function showMessage(message, type = 'success') {
            const messageDiv = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
            const icon = type === 'success' ? '‚úÖ' : '‚ùå';
            
            messageDiv.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300`;
            messageDiv.innerHTML = `${icon} ${message}`;
            document.body.appendChild(messageDiv);
            
            // Animation
            setTimeout(() => messageDiv.style.transform = 'translateX(0)', 10);
            
            // T·ª± ƒë·ªông ·∫©n
            setTimeout(() => {
                messageDiv.style.transform = 'translateX(100%)';
                setTimeout(() => messageDiv.remove(), 300);
            }, 3000);
        }

        // Load booked services for rating
        async function loadBookedServices() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const bookingId = urlParams.get('booking_id') || 1;
                
                const response = await fetch(`${API_URL}/bookings/${bookingId}/services`);
                if (response.ok) {
                    const data = await response.json();
                    bookedServices = data.services || [];
                    
                    if (bookedServices.length > 0) {
                        displayBookedServicesRating();
                        document.getElementById('serviceQualitySection').style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('Error loading booked services:', error);
            }
        }

        function getServiceIcon(category) {
            const icons = {
                'food': 'üçΩÔ∏è',
                'transport': 'üöó', 
                'spa': 'üíÜ',
                'laundry': 'üëï',
                'other': '‚≠ê'
            };
            return icons[category] || '‚≠ê';
        }

        function displayBookedServicesRating() {
            const container = document.getElementById('bookedServicesRating');
            
            container.innerHTML = bookedServices.map(service => `
                <div class="mb-6 p-4 border border-gray-200 rounded-lg">
                    <div class="flex items-center mb-3">
                        <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 mr-3">
                            ${getServiceIcon(service.category || 'other')}
                        </div>
                        <div>
                            <h4 class="font-medium text-gray-900">${service.service_name}</h4>
                            <p class="text-sm text-gray-500">${service.service_price?.toLocaleString('vi-VN')} VND</p>
                        </div>
                    </div>
                    <div class="star-rating" data-rating="service-${service.service_id}">
                        <span class="star" data-value="1">‚òÖ</span>
                        <span class="star" data-value="2">‚òÖ</span>
                        <span class="star" data-value="3">‚òÖ</span>
                        <span class="star" data-value="4">‚òÖ</span>
                        <span class="star" data-value="5">‚òÖ</span>
                    </div>
                    <p class="text-sm text-gray-500 mt-2">Ch∆∞a ƒë√°nh gi√°</p>
                    <textarea 
                        id="service-comment-${service.service_id}" 
                        rows="2" 
                        class="w-full mt-3 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-transparent text-sm"
                        placeholder="Nh·∫≠n x√©t v·ªÅ d·ªãch v·ª• n√†y...">
                    </textarea>
                </div>
            `).join('');
            
            // Add event listeners for service ratings
            document.querySelectorAll('[data-rating^="service-"]').forEach(rating => {
                const stars = rating.querySelectorAll('.star');
                const serviceId = rating.getAttribute('data-rating').replace('service-', '');
                
                stars.forEach((star, index) => {
                    star.addEventListener('click', () => {
                        const value = index + 1;
                        serviceRatings[serviceId] = value;
                        updateStars(rating, value);
                        updateRatingText(rating, value);
                    });
                    
                    star.addEventListener('mouseover', () => {
                        updateStars(rating, index + 1);
                    });
                });
                
                rating.addEventListener('mouseleave', () => {
                    const currentValue = serviceRatings[serviceId] || 0;
                    updateStars(rating, currentValue);
                });
            });
        }

        // Initialize
        checkAuth();
        loadBookedServices();
    </script>
</body>
</html>
